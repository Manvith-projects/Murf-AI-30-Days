<!-- Murf Branding -->
<a href="https://murf.ai/api/docs/introduction/overview" target="_blank" style="position: fixed; bottom: 18px; right: 18px; z-index: 9999; background: rgba(60,0,120,0.85); color: #fff; padding: 10px 18px; border-radius: 1em; font-weight: bold; font-family: inherit; text-decoration: none; box-shadow: 0 2px 12px rgba(60,0,120,0.15); transition: background 0.2s;">
  <span style="vertical-align: middle;">ðŸ”Š Powered by <span style="color:#ffb300;">Murf</span></span>
</a>
<!-- LED Control Panel (MQTT) -->
<div style="margin: 2em 0; padding: 1em; background: rgba(255,255,255,0.1); border-radius: 1em; max-width: 400px;">
  <h3>ESP32 LED Control (MQTT)</h3>
  <button onclick="sendLedCommand('on')">Turn LED On</button>
  <button onclick="sendLedCommand('off')">Turn LED Off</button>
</div>

<script>
function sendLedCommand(command) {
  fetch('/control-device', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      topic: 'led', // must match your ESP32 topic
      command: command
    })
  })
  .then(res => res.json())
  .then(data => alert(data.success ? 'Command sent!' : 'Failed to send command'))
  .catch(err => alert('Error: ' + err));
}
</script>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Voice Chat</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, #23243a 0%, #2d2e4a 100%);
      font-family: 'Inter', sans-serif;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
    }
    .layout-root {
      display: flex;
      flex-direction: row;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar, .api-sidebar {
      width: 220px;
      min-width: 180px;
      max-width: 260px;
      background: rgba(30,34,44,0.92);
      border-right: 1.5px solid #23243a;
      display: flex;
      flex-direction: column;
      z-index: 10;
      padding: 1.5rem 0.7rem 1rem 0.7rem;
      box-shadow: 2px 0 24px #0002;
      gap: 1.2rem;
      height: 100vh;
    }
    .api-sidebar {
      border-right: none;
      border-left: 1.5px solid #23243a;
      box-shadow: -2px 0 24px #0002;
      align-items: flex-start;
      padding: 1.5rem 0.7rem 1rem 0.7rem;
      overflow-y: auto;
      max-height: 100vh;
    }
    .sidebar .logo, .api-sidebar .logo {
      font-size: 1.3rem;
      font-weight: 700;
      color: #4facfe;
      margin-bottom: 1.2rem;
      text-align: center;
      letter-spacing: 0.5px;
      width: 100%;
    }
    .sidebar button#newChatBtn {
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 1.2rem;
      padding: 0.7rem 1.2rem;
      cursor: pointer;
      box-shadow: 0 2px 8px #4facfe33;
      transition: background 0.2s;
    }
    .sidebar #chatHistoryList button {
      background: rgba(255,255,255,0.08);
      color: #e0e0e0;
      border: none;
      border-radius: 8px;
      width: 100%;
      text-align: left;
      padding: 0.5rem 0.7rem;
      margin-bottom: 0.3rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .sidebar #chatHistoryList button:hover {
      background: #353a4a;
    }
    .api-panel {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
      align-items: flex-start;
    }
    .api-panel label, .api-panel input, .api-panel button {
      font-size: 0.98rem;
    }
    .api-panel input {
      background: #23242b;
      color: #e0e0e0;
      border: 1px solid #333;
      border-radius: 7px;
      padding: 0.2rem 0.6rem;
      font-size: 1rem;
      outline: none;
      margin-right: 0.7rem;
      transition: border 0.2s, box-shadow 0.2s;
    }
    .api-panel input:focus {
      border: 1.5px solid #4facfe;
      box-shadow: 0 2px 8px #4facfe33;
    }
    .api-panel button {
      background: #353a4a;
      color: #e0e0e0;
      border: none;
      padding: 0.3rem 1.1rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 0.5rem;
      transition: background 0.2s, box-shadow 0.2s, color 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
    }
    .api-panel button:hover {
      background: #4facfe;
      color: #fff;
      box-shadow: 0 4px 16px #4facfe33;
    }
    #apiKeyStatus {
      font-size: 0.98rem;
      color: #afffaf;
    }
    .main {
      flex: 1;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 6.5rem;
      background: transparent;
    }
    .chat-card {
      background: rgba(255,255,255,0.18);
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      padding: 2.5rem 2rem 1.5rem 2rem;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      text-align: center;
      max-width: 540px;
      width: 100%;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      margin-bottom: 2.5rem;
    }
    .chat-container {
      min-height: 300px;
      margin-bottom: 1.5rem;
      background: rgba(0,0,0,0.08);
      border-radius: 12px;
      padding: 1.2rem 1rem;
      max-height: 350px;
      overflow-y: auto;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      min-width: 320px;
    }
    .chat-message {
      display: flex;
      align-items: flex-start;
      margin-bottom: 1.1rem;
    }
    .chat-message.user .bubble {
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: #fff;
      align-self: flex-end;
      margin-left: auto;
    }
    .chat-message.assistant .bubble {
      background: linear-gradient(135deg, #ff6a88, #ff3d7a);
      color: #fff;
      align-self: flex-start;
      margin-right: auto;
    }
    .bubble {
      padding: 0.7rem 1.1rem;
      border-radius: 16px;
      font-size: 1.08rem;
      max-width: 80%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      word-break: break-word;
    }
    .chat-message .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin-right: 0.7rem;
      margin-top: 0.1rem;
      background: #fff;
      object-fit: cover;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .chat-message.user .avatar {
      margin-left: 0.7rem;
      margin-right: 0;
      order: 2;
    }
    .chat-message.assistant .avatar {
      order: 1;
    }
    .input-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 1.2rem;
    }
    .record-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4facfe 60%, #00f2fe 100%);
      color: #fff;
      border: none;
      font-size: 2rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px #4facfe55;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s, color 0.2s, transform 0.1s;
      margin: 0 auto;
      margin-bottom: 1rem;
      outline: none;
      position: relative;
      animation: none;
    }
    .record-btn:hover {
      background: linear-gradient(135deg, #00f2fe 60%, #4facfe 100%);
      color: #fff;
      transform: scale(1.07);
      box-shadow: 0 8px 32px #4facfe77;
    }
    .record-btn.recording {
      background: linear-gradient(135deg, #ff6a88 60%, #ff3d7a 100%);
      color: #fff;
      animation: pulse-mic 1.2s infinite;
      box-shadow: 0 0 0 0 #ff6a8855, 0 8px 32px #ff6a8855;
    }
    @keyframes pulse-mic {
      0% { box-shadow: 0 0 0 0 #ff6a8855, 0 8px 32px #ff6a8855; }
      70% { box-shadow: 0 0 0 18px #ff6a8822, 0 8px 32px #ff6a8855; }
      100% { box-shadow: 0 0 0 0 #ff6a8855, 0 8px 32px #ff6a8855; }
    }
    @media (max-width: 900px) {
      .layout-root { flex-direction: column; }
      .sidebar, .api-sidebar { width: 100vw; min-width: unset; max-width: unset; height: auto; border-right: none; border-bottom: 1.5px solid #23243a; }
      .main { margin-left: 0; margin-right: 0; padding-top: 8.5rem; }
    }
    @media (max-width: 700px) {
      .chat-card { max-width: 98vw; padding-left: 0.5rem; padding-right: 0.5rem; }
      .sidebar, .api-sidebar { flex-direction: row; }
    }
  </style>
</head>
<body>
  <div class="layout-root">
    <div class="sidebar">
      <div class="logo">Chat History</div>
      <button id="newChatBtn">+ New Chat</button>
      <div id="chatHistoryList" style="flex:1;overflow-y:auto;"></div>
    </div>
    <div class="main">
      <div class="chat-card">
        <div id="deleteChatBtnContainer" style="text-align:right;margin-bottom:0.5rem;"></div>
        <h1>Conversational AI Demo</h1>
        <div class="subtitle">ðŸŽ§ Realtime Speech-to-Text + LLM + Murf TTS</div>
        <div class="chat-container" id="chatContainer"></div>
        <div class="input-controls">
          <button id="recordBtn" class="record-btn"><span style="font-size:2.2rem;">ðŸŽ¤</span></button>
          <div id="liveTranscript" class="live-transcript"></div>
        </div>
      </div>
    </div>
    <div class="api-sidebar">
      <div class="logo">API Keys</div>
      <form class="api-panel">
        <label>AssemblyAI Key:<input id="assemblyKey" type="password"></label>
        <label>Gemini Key:<input id="geminiKey" type="password"></label>
        <label>Murf Key:<input id="murfKey" type="password"></label>
        <label>OpenAI Key:<input id="openaiKey" type="password"></label>
        <input type="file" id="envUpload" accept=".env">
        <button type="button" id="saveKeysBtn">Save</button>
        <button type="button" id="resetKeysBtn">Clear</button>
        <span id="apiKeyStatus"></span>
      </form>
      <div class="logo" style="margin-top:2rem;">Smart Devices</div>
      <form id="deviceForm" style="display:flex;flex-direction:column;gap:0.5rem;width:100%;">
        <input id="deviceName" type="text" placeholder="Device Name" required style="width:100%;">
        <input id="deviceType" type="text" placeholder="Device Type (e.g. ESP32)" required style="width:100%;">
        <input id="deviceTopic" type="text" placeholder="MQTT Topic (e.g. esp32/led)" required style="width:100%;">
        <input id="mqttHost" type="text" placeholder="MQTT Broker Host (e.g. broker.hivemq.com)" required style="width:100%;">
        <input id="mqttPort" type="number" placeholder="MQTT Port (default 1883)" style="width:100%;">
        <input id="mqttUser" type="text" placeholder="MQTT Username (optional)" style="width:100%;">
        <input id="mqttPass" type="password" placeholder="MQTT Password (optional)" style="width:100%;">
        <button type="submit" style="background:#4facfe;color:#fff;border:none;border-radius:6px;padding:0.3rem 0.7rem;">Add Device</button>
      </form>
      <div id="deviceList" style="margin-top:1rem;width:100%;"></div>
    </div>
  </div>
  <script>
    // --- Smart Devices logic ---
    function getDevices() {
      return JSON.parse(localStorage.getItem('smartDevices') || '[]');
    }
    function saveDevices(devices) {
      localStorage.setItem('smartDevices', JSON.stringify(devices));
    }
    function renderDeviceList() {
      const listDiv = document.getElementById('deviceList');
      const devices = getDevices();
      if (!devices.length) {
        listDiv.innerHTML = '<i>No devices added.</i>';
        return;
      }
      listDiv.innerHTML = '<b>My Devices</b><ul style="margin:0.5rem 0 0 0.5rem;padding:0;">' +
        devices.map((d,i) => `<li><b>${d.name}</b> (${d.type})<br>Topic: <code>${d.topic||''}</code><br>Broker: <code>${d.mqttHost||''}${d.mqttPort?':'+d.mqttPort:''}</code> <button onclick="removeDevice(${i})" style="margin-left:0.5rem;background:#ff6a88;color:#fff;border:none;border-radius:6px;padding:0.1rem 0.5rem;">Remove</button></li>`).join('') + '</ul>';
    }
    function removeDevice(idx) {
      let devices = getDevices();
      devices.splice(idx, 1);
      saveDevices(devices);
      renderDeviceList();
    }
    document.getElementById('deviceForm').onsubmit = function(e) {
      e.preventDefault();
      const name = document.getElementById('deviceName').value.trim();
      const type = document.getElementById('deviceType').value.trim();
      const topic = document.getElementById('deviceTopic').value.trim();
      const mqttHost = document.getElementById('mqttHost').value.trim();
      const mqttPort = document.getElementById('mqttPort').value.trim();
      const mqttUser = document.getElementById('mqttUser').value.trim();
      const mqttPass = document.getElementById('mqttPass').value.trim();
      if (!name || !type || !topic || !mqttHost) return;
      let devices = getDevices();
      devices.push({ name, type, topic, mqttHost, mqttPort, mqttUser, mqttPass });
      saveDevices(devices);
      renderDeviceList();
      document.getElementById('deviceForm').reset();
    };
    window.addEventListener('DOMContentLoaded', renderDeviceList);
  // --- Chat UI logic ---
    let chatHistory = [];
    const chatContainer = document.getElementById('chatContainer');
    function renderChat() {
      chatContainer.innerHTML = '';
      chatHistory.forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message ' + msg.role;
        const avatar = document.createElement('img');
        avatar.className = 'avatar';
        avatar.src = msg.role === 'user' ? 'https://cdn-icons-png.flaticon.com/512/1946/1946429.png' : 'https://cdn-icons-png.flaticon.com/512/4712/4712035.png';
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.textContent = msg.content;
        if (msg.role === 'user') {
          msgDiv.appendChild(bubble);
          msgDiv.appendChild(avatar);
        } else {
          msgDiv.appendChild(avatar);
          msgDiv.appendChild(bubble);
          if (msg.image_url) {
            const img = document.createElement('img');
            img.src = msg.image_url;
            img.alt = 'Generated Image';
            img.style.maxWidth = '90%';
            img.style.display = 'block';
            img.style.margin = '12px auto 0 auto';
            img.style.borderRadius = '12px';
            img.style.boxShadow = '0 2px 12px rgba(0,0,0,0.15)';
            msgDiv.appendChild(img);
          }
        }
        chatContainer.appendChild(msgDiv);
      });
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // --- WebSocket logic ---
    let isRecording = false;
    const recordBtn = document.getElementById('recordBtn');
    const liveTranscriptDiv = document.getElementById('liveTranscript');
    let ws, audioCtx, processor, input, stream;
    let assistantStreamingMsg = null;
    function connectWebSocket() {
      const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
      ws = new WebSocket(wsProtocol + window.location.host + '/transcribe-ws');
      ws.binaryType = 'arraybuffer';
      ws.onopen = () => {
        const keys = {
          assemblyKey: document.getElementById('assemblyKey').value,
          geminiKey: document.getElementById('geminiKey').value,
          murfKey: document.getElementById('murfKey').value,
          openaiKey: document.getElementById('openaiKey').value
        };
        console.log('WebSocket opened, sending API keys:', keys);
        ws.send(JSON.stringify(keys));
        startAudio();
      };
      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          if (msg.type === 'partial') liveTranscriptDiv.textContent = msg.transcript;
          if (msg.type === 'end_of_turn') {
            chatHistory.push({ role: 'user', content: msg.transcript });
            renderChat();
          }
          if (msg.type === 'assistant_chunk' && msg.text) handleAssistantChunk(msg.text);
          if (msg.type === 'assistant_image' && msg.image_url) {
            if (chatHistory.length > 0) {
              let lastMsg = chatHistory[chatHistory.length - 1];
              if (lastMsg.role === 'assistant') {
                lastMsg.image_url = msg.image_url;
                renderChat();
              }
            }
          }
          if (msg.type === 'audio_chunk' && msg.audio_b64) playBase64AudioChunk(msg.audio_b64);
          if (msg.type === 'web_search_opened') {
            chatHistory.push({ role: 'assistant', content: "I've opened the latest information for you in your browser!" });
            renderChat();
          }
          if (msg.type === 'audio_done') {
            if (ws && ws.readyState === WebSocket.OPEN) ws.close();
            stopAudio();
            assistantStreamingMsg = null;
          }
        } catch {}
      };
      ws.onclose = () => { console.log('WebSocket closed'); stopAudio(); };
      ws.onerror = (e) => { console.error('WebSocket error:', e); };
      // Audio chunk queue
      if (!window.audioChunkQueue) window.audioChunkQueue = [];
      if (!window.isAudioChunkPlaying) window.isAudioChunkPlaying = false;
      if (!window.audioChunkContext) window.audioChunkContext = new (window.AudioContext || window.webkitAudioContext)();
      function playBase64AudioChunk(base64) {
        const audioData = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
        window.audioChunkContext.decodeAudioData(audioData.buffer.slice(0), (buffer) => {
          window.audioChunkQueue.push(buffer);
          if (!window.isAudioChunkPlaying) playNextAudioChunk();
        });
      }
      function playNextAudioChunk() {
        if (window.audioChunkQueue.length === 0) {
          window.isAudioChunkPlaying = false;
          return;
        }
        window.isAudioChunkPlaying = true;
        const buffer = window.audioChunkQueue.shift();
        const source = window.audioChunkContext.createBufferSource();
        source.buffer = buffer;
        source.connect(window.audioChunkContext.destination);
        source.start();
        source.onended = playNextAudioChunk;
      }
    }
    function startAudio() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Your browser does not support audio recording. Please use a modern browser like Chrome or Firefox, and ensure you are running on HTTPS or localhost.');
        recordBtn.textContent = 'Start Recording';
        recordBtn.classList.remove('recording');
        return;
      }
      navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
        stream = s;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
        input = audioCtx.createMediaStreamSource(stream);
        processor = audioCtx.createScriptProcessor(4096, 1, 1);
        processor.onaudioprocess = (e) => {
          if (!isRecording) return;
          const inputData = e.inputBuffer.getChannelData(0);
          const pcm16 = new Int16Array(inputData.length);
          for (let i = 0; i < inputData.length; i++) {
            let s = Math.max(-1, Math.min(1, inputData[i]));
            pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
          }
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(pcm16.buffer);
            // Debug: log that audio chunk is sent
            console.log('Sent audio chunk, length:', pcm16.length);
          }
        };
        input.connect(processor);
        processor.connect(audioCtx.destination);
        isRecording = true;
        recordBtn.textContent = 'Stop Recording';
        recordBtn.classList.add('recording');
        console.log('Audio recording started');
      }).catch(err => {
        alert('Microphone access denied or unavailable. Please check your browser settings and permissions.');
        recordBtn.textContent = 'Start Recording';
        recordBtn.classList.remove('recording');
        console.error('getUserMedia error:', err);
      });
    }
    function stopAudio() {
      isRecording = false;
      if (processor) processor.disconnect();
      if (input) input.disconnect();
      if (audioCtx) audioCtx.close();
      if (stream) stream.getTracks().forEach(t => t.stop());
      recordBtn.textContent = 'Start Recording';
      recordBtn.classList.remove('recording');
      liveTranscriptDiv.textContent = '';
    }
    recordBtn.onclick = () => {
      const keys = {
        assemblyKey: document.getElementById('assemblyKey').value,
        geminiKey: document.getElementById('geminiKey').value,
        murfKey: document.getElementById('murfKey').value,
        openaiKey: document.getElementById('openaiKey').value
      };
      if (!keys.assemblyKey || !keys.geminiKey || !keys.murfKey || !keys.openaiKey) {
        alert('Please enter all API keys before using the voice agent.');
        return;
      }
      if (!isRecording) {
        connectWebSocket();
      } else {
        isRecording = false;
        if (processor) processor.disconnect();
        if (input) input.disconnect();
        if (audioCtx) audioCtx.close();
        if (stream) stream.getTracks().forEach(t => t.stop());
        recordBtn.textContent = 'Start Recording';
        recordBtn.classList.remove('recording');
        liveTranscriptDiv.textContent = '';
      }
    };
    function handleAssistantChunk(text) {
      if (!assistantStreamingMsg) {
        assistantStreamingMsg = { role: 'assistant', content: text };
        chatHistory.push(assistantStreamingMsg);
      } else {
        assistantStreamingMsg.content += text;
      }
      renderChat();
    }
    // Restore API keys from localStorage on page load
    window.addEventListener('DOMContentLoaded', () => {
      const keyFields = ['assemblyKey','geminiKey','murfKey','openaiKey'];
      keyFields.forEach(id => {
        const val = localStorage.getItem(id);
        if(val) document.getElementById(id).value = val;
      });
    });
    // Save and clear buttons
    document.getElementById('saveKeysBtn').onclick = () => {
      ['assemblyKey','geminiKey','murfKey','openaiKey'].forEach(id => {
        const val = document.getElementById(id).value;
        if(val) localStorage.setItem(id, val);
      });
      document.getElementById('apiKeyStatus').textContent = 'API keys saved!';
      setTimeout(()=>document.getElementById('apiKeyStatus').textContent='', 1500);
    };
    document.getElementById('resetKeysBtn').onclick = () => {
      ['assemblyKey','geminiKey','murfKey','openaiKey'].forEach(id => {
        localStorage.removeItem(id);
        document.getElementById(id).value = '';
      });
      document.getElementById('apiKeyStatus').textContent = 'API keys cleared!';
      setTimeout(()=>document.getElementById('apiKeyStatus').textContent='', 1500);
    };
    // .env upload logic
    document.getElementById('envUpload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const text = evt.target.result;
        const lines = text.split(/\r?\n/);
        lines.forEach(line => {
          if (line.startsWith('ASSEMBLYAI_API_KEY=')) document.getElementById('assemblyKey').value = line.split('=')[1].trim();
          if (line.startsWith('GEMINI_API_KEY=')) document.getElementById('geminiKey').value = line.split('=')[1].trim();
          if (line.startsWith('MURF_API_KEY=')) document.getElementById('murfKey').value = line.split('=')[1].trim();
          if (line.startsWith('OPENAI_API_KEY=')) document.getElementById('openaiKey').value = line.split('=')[1].trim();
        });
        document.getElementById('apiKeyStatus').textContent = '.env loaded!';
        setTimeout(()=>document.getElementById('apiKeyStatus').textContent='', 1500);
      };
      reader.readAsText(file);
    });
    // --- Chat History Sidebar Logic ---
    function getChatHistories() {
      return JSON.parse(localStorage.getItem('chatHistories') || '[]');
    }
    function saveChatHistories(histories) {
      localStorage.setItem('chatHistories', JSON.stringify(histories));
    }
    function saveCurrentChatToHistory() {
      if (!chatHistory.length) return;
      let histories = getChatHistories();
      const title = chatHistory[0]?.content?.slice(0, 30) || 'Chat ' + (histories.length + 1);
      histories.unshift({ title: title + ' - ' + new Date().toLocaleString(), messages: chatHistory });
      if (histories.length > 20) histories = histories.slice(0, 20);
      saveChatHistories(histories);
    }
    let currentChatIndex = null;
    function renderHistorySidebar() {
      const list = document.getElementById('chatHistoryList');
      const histories = getChatHistories();
      list.innerHTML = '';
      histories.forEach((h, i) => {
        const row = document.createElement('div');
        row.style = 'display:flex;align-items:center;margin-bottom:0.3rem;position:relative;';
        const btn = document.createElement('button');
        btn.textContent = h.title;
        btn.style = 'flex:1;text-align:left;padding:0.5rem 0.7rem;border:none;background:rgba(255,255,255,0.08);color:#e0e0e0;border-radius:6px;cursor:pointer;transition:background 0.2s;';
        btn.onmouseover = () => btn.style.background = '#353a4a';
        btn.onmouseout = () => btn.style.background = 'rgba(255,255,255,0.08)';
        btn.onclick = () => {
          chatHistory = h.messages;
          currentChatIndex = i;
          renderChat();
          renderHistorySidebar();
        };
        row.appendChild(btn);
        // Only show delete button for the currently open chat
        if (currentChatIndex === i) {
          const del = document.createElement('button');
          del.textContent = 'Delete Chat';
          del.title = 'Delete this chat';
          del.style = 'margin-left:0.5rem;background:#ff6a88;border:none;color:#fff;font-size:0.98rem;cursor:pointer;border-radius:6px;padding:0.3rem 0.7rem;transition:background 0.2s;position:absolute;right:0.5rem;top:50%;transform:translateY(-50%);';
          del.onmouseover = () => del.style.background = '#ff3d7a';
          del.onmouseout = () => del.style.background = '#ff6a88';
          del.onclick = (e) => {
            e.stopPropagation();
            let histories = getChatHistories();
            histories.splice(i, 1);
            saveChatHistories(histories);
            chatHistory = [];
            currentChatIndex = null;
            renderChat();
            renderHistorySidebar();
          };
          row.appendChild(del);
        }
        list.appendChild(row);
      });
    }
    // --- Persistent memory: load on startup, save on unload and after delete ---
    window.addEventListener('DOMContentLoaded', renderHistorySidebar);
    window.addEventListener('beforeunload', () => {
      saveCurrentChatToHistory();
      // Already in localStorage, so nothing else needed
    });
    document.getElementById('newChatBtn').onclick = () => {
      saveCurrentChatToHistory();
      chatHistory = [];
      renderChat();
      renderHistorySidebar();
    };
    // Save chat on page unload
    window.addEventListener('beforeunload', saveCurrentChatToHistory);
    // Render sidebar on load
    renderHistorySidebar();
    function renderDeleteChatBtn() {
      const container = document.getElementById('deleteChatBtnContainer');
      container.innerHTML = '';
      if (currentChatIndex !== null) {
        const btn = document.createElement('button');
        btn.textContent = 'Delete Chat';
        btn.title = 'Delete this chat';
        btn.style = 'background:#ff6a88;border:none;color:#fff;font-size:0.98rem;cursor:pointer;border-radius:6px;padding:0.3rem 0.9rem;transition:background 0.2s;margin-bottom:0.5rem;';
        btn.onmouseover = () => btn.style.background = '#ff3d7a';
        btn.onmouseout = () => btn.style.background = '#ff6a88';
        btn.onclick = () => {
          let histories = getChatHistories();
          histories.splice(currentChatIndex, 1);
          saveChatHistories(histories);
          chatHistory = [];
          currentChatIndex = null;
          renderChat();
          renderHistorySidebar();
          renderDeleteChatBtn();
        };
        container.appendChild(btn);
      }
    }
    // Call renderDeleteChatBtn after chat load and sidebar render
    function renderChat() {
      chatContainer.innerHTML = '';
      chatHistory.forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message ' + msg.role;
        const avatar = document.createElement('img');
        avatar.className = 'avatar';
        avatar.src = msg.role === 'user' ? 'https://cdn-icons-png.flaticon.com/512/1946/1946429.png' : 'https://cdn-icons-png.flaticon.com/512/4712/4712035.png';
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.textContent = msg.content;
        if (msg.role === 'user') {
          msgDiv.appendChild(bubble);
          msgDiv.appendChild(avatar);
        } else {
          msgDiv.appendChild(avatar);
          msgDiv.appendChild(bubble);
          if (msg.image_url) {
            const img = document.createElement('img');
            img.src = msg.image_url;
            img.alt = 'Generated Image';
            img.style.maxWidth = '90%';
            img.style.display = 'block';
            img.style.margin = '12px auto 0 auto';
            img.style.borderRadius = '12px';
            img.style.boxShadow = '0 2px 12px rgba(0,0,0,0.15)';
            msgDiv.appendChild(img);
          }
        }
        chatContainer.appendChild(msgDiv);
      });
      chatContainer.scrollTop = chatContainer.scrollHeight;
      renderDeleteChatBtn();
    }
    function renderHistorySidebar() {
      const list = document.getElementById('chatHistoryList');
      const histories = getChatHistories();
      list.innerHTML = '';
      histories.forEach((h, i) => {
        const row = document.createElement('div');
        row.style = 'display:flex;align-items:center;margin-bottom:0.3rem;position:relative;';
        const btn = document.createElement('button');
        btn.textContent = h.title;
        btn.style = 'flex:1;text-align:left;padding:0.5rem 0.7rem;border:none;background:rgba(255,255,255,0.08);color:#e0e0e0;border-radius:6px;cursor:pointer;transition:background 0.2s;';
        btn.onmouseover = () => btn.style.background = '#353a4a';
        btn.onmouseout = () => btn.style.background = 'rgba(255,255,255,0.08)';
        btn.onclick = () => {
          chatHistory = h.messages;
          currentChatIndex = i;
          renderChat();
          renderHistorySidebar();
        };
        row.appendChild(btn);
        list.appendChild(row);
      });
    }
    // --- Agent Memory Logic ---
    function getAgentMemory() {
      return JSON.parse(localStorage.getItem('agentMemory') || '[]');
    }
    function saveAgentMemory(memory) {
      localStorage.setItem('agentMemory', JSON.stringify(memory));
    }
    function addFactToMemory(fact) {
      let memory = getAgentMemory();
      memory.push(fact);
      saveAgentMemory(memory);
    }
    function clearAgentMemory() {
      localStorage.removeItem('agentMemory');
    }
    // UI for memory management
    function renderMemoryPanel() {
      let panel = document.getElementById('agentMemoryPanel');
      if (!panel) {
        panel = document.createElement('div');
        panel.id = 'agentMemoryPanel';
        panel.style = 'margin:1.2rem 0;padding:0.7rem 1rem;background:rgba(255,255,255,0.08);border-radius:10px;';
        document.querySelector('.api-sidebar').appendChild(panel);
      }
      const memory = getAgentMemory();
      panel.innerHTML = '<b>Agent Memory</b><br>' + (memory.length ? '<ul style="margin:0.5rem 0 0 1.2rem;padding:0;">' + memory.map(f=>`<li>${f}</li>`).join('') + '</ul>' : '<i>No facts stored.</i>') +
        '<br><input id="addFactInput" type="text" placeholder="Add fact..." style="width:70%;margin-right:0.5rem;">' +
        '<button id="addFactBtn" style="background:#4facfe;color:#fff;border:none;border-radius:6px;padding:0.2rem 0.7rem;">Add</button>' +
        '<button id="clearFactBtn" style="background:#ff6a88;color:#fff;border:none;border-radius:6px;padding:0.2rem 0.7rem;margin-left:0.5rem;">Clear</button>';
      document.getElementById('addFactBtn').onclick = () => {
        const val = document.getElementById('addFactInput').value.trim();
        if (val) {
          addFactToMemory(val);
          renderMemoryPanel();
        }
      };
      document.getElementById('clearFactBtn').onclick = () => {
        if (confirm('Clear all agent memory?')) {
          clearAgentMemory();
          renderMemoryPanel();
        }
      };
    }
    window.addEventListener('DOMContentLoaded', renderMemoryPanel);
    // --- When sending a message, include agent memory in the prompt ---
    function getPromptWithMemory(chatHistory) {
      const memory = getAgentMemory();
      let memoryBlock = memory.length ? '\nAgent memory (facts to use in any chat):\n' + memory.map(f=>'- '+f).join('\n')+'\n' : '';
      // If chatHistory is a list of messages, join their content
      let chatBlock = Array.isArray(chatHistory) ? chatHistory.map(m=>m.content).join('\n') : chatHistory;
      return chatBlock + memoryBlock;
    }
    // --- Auto-learn facts from chat ---
    function extractFactsFromMessage(msg) {
      // Simple heuristic: look for sentences like "Remember that ...", "My ... is ...", "I am ...", "You are ...", "The capital of ... is ..."
      const patterns = [
        /remember that (.+?)[.!?]/i,
        /my ([\w ]+) is ([^.!?]+)/i,
        /i am ([^.!?]+)/i,
        /you are ([^.!?]+)/i,
        /the capital of ([\w ]+) is ([^.!?]+)/i
      ];
      let facts = [];
      for (const pat of patterns) {
        let m = msg.match(pat);
        if (m) facts.push(m[0]);
      }
      return facts;
    }
    function learnFactsFromChat(chatHistory) {
      let memory = getAgentMemory();
      chatHistory.forEach(msg => {
        if (!msg.content) return;
        const facts = extractFactsFromMessage(msg.content);
        facts.forEach(fact => {
          if (!memory.includes(fact)) memory.push(fact);
        });
      });
      saveAgentMemory(memory);
      renderMemoryPanel();
    }
    // Call learnFactsFromChat after each chat update
    function renderChat() {
      chatContainer.innerHTML = '';
      chatHistory.forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message ' + msg.role;
        const avatar = document.createElement('img');
        avatar.className = 'avatar';
        avatar.src = msg.role === 'user' ? 'https://cdn-icons-png.flaticon.com/512/1946/1946429.png' : 'https://cdn-icons-png.flaticon.com/512/4712/4712035.png';
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.textContent = msg.content;
        if (msg.role === 'user') {
          msgDiv.appendChild(bubble);
          msgDiv.appendChild(avatar);
        } else {
          msgDiv.appendChild(avatar);
          msgDiv.appendChild(bubble);
          if (msg.image_url) {
            const img = document.createElement('img');
            img.src = msg.image_url;
            img.alt = 'Generated Image';
            img.style.maxWidth = '90%';
            img.style.display = 'block';
            img.style.margin = '12px auto 0 auto';
            img.style.borderRadius = '12px';
            img.style.boxShadow = '0 2px 12px rgba(0,0,0,0.15)';
            msgDiv.appendChild(img);
          }
        }
        chatContainer.appendChild(msgDiv);
      });
      chatContainer.scrollTop = chatContainer.scrollHeight;
      learnFactsFromChat(chatHistory);
      renderDeleteChatBtn();
    }
  </script>
</body>
</html>
